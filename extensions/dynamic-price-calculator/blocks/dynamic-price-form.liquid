{% comment %}
  Dinamik Fiyat Hesaplayıcı - Tema Bloğu
  
  Bu blok ürün sayfasına eklenerek kullanıcıdan:
  - Boy (mm)
  - En (mm)  
  - Materyal (Ahşap/Metal/Plastik)
  bilgilerini alır ve dinamik fiyat hesaplar.
{% endcomment %}

<div class="dynamic-price-calculator" data-product-id="{{ product.id }}">
  <div class="calculator-form">
    <h3 class="calculator-title">{{ block.settings.title }}</h3>
    <p class="calculator-description">{{ block.settings.description }}</p>
    
    <form id="dynamic-price-form" class="price-form">
      {%- comment -%} Boy girişi {%- endcomment -%}
      <div class="form-group">
        <label for="height-input">
          Boy (mm)
          <span class="required">*</span>
        </label>
        <input 
          type="number" 
          id="height-input" 
          name="height" 
          min="100" 
          max="5000" 
          step="1"
          placeholder="Örn: 400"
          required
        >
        <small class="help-text">100mm - 5000mm arası</small>
      </div>
      
      {%- comment -%} En girişi {%- endcomment -%}
      <div class="form-group">
        <label for="width-input">
          En (mm)
          <span class="required">*</span>
        </label>
        <input 
          type="number" 
          id="width-input" 
          name="width" 
          min="100" 
          max="5000" 
          step="1"
          placeholder="Örn: 500"
          required
        >
        <small class="help-text">100mm - 5000mm arası</small>
      </div>
      
      {%- comment -%} Materyal seçimi {%- endcomment -%}
      <div class="form-group">
        <label for="material-select">
          Materyal
          <span class="required">*</span>
        </label>
        <select id="material-select" name="material" required>
          <option value="">Seçiniz...</option>
          <option value="wood">Ahşap (+50 TL)</option>
          <option value="metal">Metal (+100 TL)</option>
          <option value="plastic">Plastik (+30 TL)</option>
        </select>
      </div>
      
      {%- comment -%} Dinamik fiyat gösterimi {%- endcomment -%}
      <div class="price-display" id="price-display" style="display: none;">
        <div class="price-label">Tahmini Fiyat:</div>
        <div class="price-value" id="price-value">0.00 TL</div>
        <div class="price-details" id="price-details"></div>
      </div>
      
      {%- comment -%} Hata mesajları {%- endcomment -%}
      <div class="error-message" id="error-message" style="display: none;"></div>
      
      {%- comment -%} Sepete ekle butonu {%- endcomment -%}
      <button 
        type="submit" 
        class="add-to-cart-btn" 
        id="add-to-cart-btn"
        disabled
      >
        <span class="btn-text">Sepete Ekle</span>
        <span class="btn-loader" style="display: none;">
          <span class="spinner"></span>
          Ekleniyor...
        </span>
      </button>
      
      {%- comment -%} Başarı mesajı {%- endcomment -%}
      <div class="success-message" id="success-message" style="display: none;">
        ✓ Ürün sepete eklendi!
      </div>
    </form>
  </div>
</div>

{%- comment -%} Stil {%- endcomment -%}
<style>
  .dynamic-price-calculator {
    margin: 2rem 0;
    padding: 1.5rem;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #f9f9f9;
  }
  
  .calculator-title {
    margin: 0 0 0.5rem;
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
  }
  
  .calculator-description {
    margin: 0 0 1.5rem;
    color: #666;
    font-size: 0.95rem;
  }
  
  .form-group {
    margin-bottom: 1.25rem;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
  }
  
  .required {
    color: #e74c3c;
  }
  
  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }
  
  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #4CAF50;
  }
  
  .help-text {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.85rem;
    color: #888;
  }
  
  .price-display {
    margin: 1.5rem 0;
    padding: 1rem;
    background: #fff;
    border: 2px solid #4CAF50;
    border-radius: 8px;
    text-align: center;
  }
  
  .price-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.5rem;
  }
  
  .price-value {
    font-size: 2rem;
    font-weight: 700;
    color: #4CAF50;
  }
  
  .price-details {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: #888;
  }
  
  .error-message {
    padding: 0.75rem;
    background: #ffebee;
    border: 1px solid #ef5350;
    border-radius: 4px;
    color: #c62828;
    margin-bottom: 1rem;
  }
  
  .success-message {
    padding: 0.75rem;
    background: #e8f5e9;
    border: 1px solid #66bb6a;
    border-radius: 4px;
    color: #2e7d32;
    margin-top: 1rem;
    text-align: center;
  }
  
  .add-to-cart-btn {
    width: 100%;
    padding: 1rem;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .add-to-cart-btn:hover:not(:disabled) {
    background: #45a049;
  }
  
  .add-to-cart-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  
  .btn-loader {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  @media (max-width: 768px) {
    .dynamic-price-calculator {
      padding: 1rem;
    }
    
    .calculator-title {
      font-size: 1.25rem;
    }
    
    .price-value {
      font-size: 1.75rem;
    }
  }
</style>

{%- comment -%} JavaScript {%- endcomment -%}
<script>
(function() {
  const form = document.getElementById('dynamic-price-form');
  const heightInput = document.getElementById('height-input');
  const widthInput = document.getElementById('width-input');
  const materialSelect = document.getElementById('material-select');
  const priceDisplay = document.getElementById('price-display');
  const priceValue = document.getElementById('price-value');
  const priceDetails = document.getElementById('price-details');
  const addToCartBtn = document.getElementById('add-to-cart-btn');
  const errorMessage = document.getElementById('error-message');
  const successMessage = document.getElementById('success-message');
  
  let debounceTimer;
  
  // Dinamik fiyat hesaplama
  function calculatePrice() {
    clearTimeout(debounceTimer);
    
    debounceTimer = setTimeout(async () => {
      const height = parseInt(heightInput.value);
      const width = parseInt(widthInput.value);
      const material = materialSelect.value;
      
      // Validasyon
      if (!height || !width || !material) {
        priceDisplay.style.display = 'none';
        addToCartBtn.disabled = true;
        return;
      }
      
      if (height < 100 || height > 5000 || width < 100 || width > 5000) {
        showError('Boy ve En 100mm ile 5000mm arasında olmalıdır');
        priceDisplay.style.display = 'none';
        addToCartBtn.disabled = true;
        return;
      }
      
      try {
        // API'den fiyat hesapla
        const formData = new FormData();
        formData.append('height', height);
        formData.append('width', width);
        formData.append('material', material);
        
        const response = await fetch('/api/calculate-price', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Fiyatı göster
          priceValue.textContent = data.calculation.formatted;
          priceDetails.innerHTML = `
            Alan: ${data.calculation.area.toLocaleString()} mm² • 
            Katsayı: ${data.calculation.coefficient} • 
            Materyal: ${data.calculation.material}
          `;
          priceDisplay.style.display = 'block';
          addToCartBtn.disabled = false;
          hideError();
        } else {
          showError(data.error);
          priceDisplay.style.display = 'none';
          addToCartBtn.disabled = true;
        }
      } catch (error) {
        console.error('Fiyat hesaplama hatası:', error);
        showError('Fiyat hesaplanamadı');
        priceDisplay.style.display = 'none';
        addToCartBtn.disabled = true;
      }
    }, 500); // 500ms debounce
  }
  
  // Input değişikliklerini dinle
  heightInput.addEventListener('input', calculatePrice);
  widthInput.addEventListener('input', calculatePrice);
  materialSelect.addEventListener('change', calculatePrice);
  
  // Form submit - sepete ekle
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const height = parseInt(heightInput.value);
    const width = parseInt(widthInput.value);
    const material = materialSelect.value;
    
    // Loading durumu
    addToCartBtn.disabled = true;
    addToCartBtn.querySelector('.btn-text').style.display = 'none';
    addToCartBtn.querySelector('.btn-loader').style.display = 'flex';
    hideError();
    hideSuccess();
    
    try {
      // Geçici ürün oluştur
      const formData = new FormData();
      formData.append('height', height);
      formData.append('width', width);
      formData.append('material', material);
      
      const response = await fetch('/api/create-temp-product', {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Sepete ekle (Shopify Cart API kullan)
        const cartResponse = await fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id: data.product.variantId,
            quantity: 1,
            properties: {
              'Boy': `${height}mm`,
              'En': `${width}mm`,
              'Materyal': data.product.material
            }
          })
        });
        
        if (cartResponse.ok) {
          showSuccess();
          // 2 saniye sonra sepete yönlendir
          setTimeout(() => {
            window.location.href = '/cart';
          }, 2000);
        } else {
          throw new Error('Sepete eklenemedi');
        }
      } else {
        showError(data.error);
      }
    } catch (error) {
      console.error('Sepete ekleme hatası:', error);
      showError('Ürün sepete eklenemedi. Lütfen tekrar deneyin.');
    } finally {
      // Loading durumunu kaldır
      addToCartBtn.disabled = false;
      addToCartBtn.querySelector('.btn-text').style.display = 'inline';
      addToCartBtn.querySelector('.btn-loader').style.display = 'none';
    }
  });
  
  // Yardımcı fonksiyonlar
  function showError(message) {
    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
  }
  
  function hideError() {
    errorMessage.style.display = 'none';
  }
  
  function showSuccess() {
    successMessage.style.display = 'block';
  }
  
  function hideSuccess() {
    successMessage.style.display = 'none';
  }
})();
</script>

{% schema %}
{
  "name": "Dinamik Fiyat Hesaplayıcı",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Başlık",
      "default": "Özel Ölçülerinizi Girin"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Açıklama",
      "default": "Ürününüzün boy, en ve materyal bilgilerini girerek özel fiyatınızı hesaplayın."
    }
  ]
}
{% endschema %}
