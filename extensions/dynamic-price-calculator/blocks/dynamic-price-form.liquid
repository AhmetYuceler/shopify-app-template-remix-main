{% comment %}
  Dynamic Price Calculator - Theme Block

  This block is added to product pages to collect:
  - Height (mm)
  - Width (mm)
  - Material (Wood/Metal/Plastic)
  and calculate dynamic pricing.
{% endcomment %}

<div
  class="dynamic-price-calculator"
  data-product-id="{{ product.id }}"
  data-variant-id="{{ product.selected_or_first_available_variant.id }}"
  data-product-title="{{ product.title | escape }}"
  data-product-image="{% if product.featured_image %}https:{{ product.featured_image | image_url: width: 800 }}{% endif %}"
  data-section-cart-drawer="{{ block.settings.cart_drawer_section_id | default: 'cart-drawer' }}"
  data-section-cart-icon="{{ block.settings.cart_icon_section_id | default: 'cart-icon-bubble' }}"
>
  <div class="calculator-form">
    <h3 class="calculator-title">{{ block.settings.title }}</h3>
    <p class="calculator-description">{{ block.settings.description }}</p>

    <form id="dynamic-price-form" class="price-form">
      {%- comment -%} Height input {%- endcomment -%}
      <div class="form-group">
        <label for="height-input">
          Height (mm)
          <span class="required">*</span>
        </label>
        <input
          type="number"
          id="height-input"
          name="height"
          min="100"
          max="5000"
          step="1"
          placeholder="e.g: 400"
          required
        >
        <small class="help-text">Between 100mm - 5000mm</small>
      </div>

      {%- comment -%} Width input {%- endcomment -%}
      <div class="form-group">
        <label for="width-input">
          Width (mm)
          <span class="required">*</span>
        </label>
        <input
          type="number"
          id="width-input"
          name="width"
          min="100"
          max="5000"
          step="1"
          placeholder="e.g: 500"
          required
        >
        <small class="help-text">Between 100mm - 5000mm</small>
      </div>

      {%- comment -%} Material selection {%- endcomment -%}
      <div class="form-group">
        <label for="material-select">
          Material
          <span class="required">*</span>
        </label>
        <select id="material-select" name="material" required>
          <option value="">Select...</option>
          <option value="wood">Wood (+50 $)</option>
          <option value="metal">Metal (+100 $)</option>
          <option value="plastic">Plastic (+30 $)</option>
        </select>
      </div>

      {%- comment -%} Dynamic price display - Live updates {%- endcomment -%}
      <div class="price-display" id="price-display" style="display: none;">
        <div class="price-label">Estimated Price:</div>
        <div class="price-value" id="price-value">0.00 $</div>
        <div class="price-details" id="price-details"></div>
      </div>

      {%- comment -%} Error messages {%- endcomment -%}
      <div class="error-message" id="error-message" style="display: none;"></div>

      {%- comment -%} Add to cart button - Shows when form is valid {%- endcomment -%}
      <button
        type="button"
        class="add-to-cart-btn"
        id="add-to-cart-btn"
        style="display: none;"
        disabled
      >
        <span class="btn-text">Add to Cart</span>
        <span class="btn-loader" style="display: none;">
          <span class="spinner"></span>
          Adding...
        </span>
      </button>

      {%- comment -%} Success message {%- endcomment -%}
      <div class="success-message" id="success-message" style="display: none;">âœ“ Product successfully added to cart!</div>

      {%- comment -%} Info message {%- endcomment -%}
      <div class="info-message" id="info-message" style="display: none;"></div>
    </form>
  </div>
</div>

{%- comment -%} Stil - Modern Minimal TasarÄ±m {%- endcomment -%}
<style>
  .dynamic-price-calculator {
    margin: 2rem auto;
    max-width: 600px;
    padding: 0;
    background: transparent;
  }

  .calculator-title {
    margin: 0 0 0.75rem;
    font-size: 1.75rem;
    font-weight: 700;
    color: #1e293b;
    letter-spacing: -0.5px;
  }

  .calculator-description {
    margin: 0 0 2rem;
    color: #64748b;
    font-size: 0.95rem;
    line-height: 1.6;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #334155;
    font-size: 0.875rem;
    letter-spacing: 0.3px;
  }

  .required {
    color: #ef4444;
    font-size: 1rem;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 1rem;
    transition: all 0.2s ease;
    background: #f8fafc;
    color: #1e293b;
    font-weight: 500;
  }

  .form-group input:hover,
  .form-group select:hover {
    border-color: #cbd5e1;
    background: #ffffff;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #3b82f6;
    background: #ffffff;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .help-text {
    display: block;
    margin-top: 0.375rem;
    font-size: 0.813rem;
    color: #94a3b8;
  }

  .price-display {
    margin: 2rem 0;
    padding: 1.5rem;
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    text-align: center;
  }

  .price-label {
    font-size: 0.875rem;
    color: #64748b;
    margin-bottom: 0.5rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .price-value {
    font-size: 2.5rem;
    font-weight: 800;
    color: #1e293b;
    letter-spacing: -1px;
    margin: 0.25rem 0;
  }

  .price-details {
    margin-top: 0.75rem;
    font-size: 0.875rem;
    color: #64748b;
    line-height: 1.5;
  }

  .price-note {
    margin-top: 1rem;
    padding: 0.875rem;
    background: #fff7ed;
    border: 1px solid #fed7aa;
    border-left: 4px solid #f97316;
    border-radius: 8px;
    font-size: 0.813rem;
    color: #9a3412;
    text-align: left;
    line-height: 1.5;
  }

  .price-note strong {
    color: #ea580c;
    font-weight: 700;
  }

  .error-message {
    padding: 1rem;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-left: 4px solid #ef4444;
    border-radius: 8px;
    color: #991b1b;
    margin-bottom: 1rem;
    font-weight: 500;
    font-size: 0.875rem;
  }

  .success-message {
    padding: 1.25rem;
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-left: 4px solid #22c55e;
    border-radius: 8px;
    color: #166534;
    margin-top: 1rem;
    text-align: left;
    font-weight: 500;
    font-size: 0.875rem;
    line-height: 1.6;
    white-space: pre-line;
  }

  .info-message {
    padding: 1rem;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-left: 4px solid #3b82f6;
    border-radius: 8px;
    color: #1e40af;
    margin-top: 1rem;
    text-align: center;
    font-weight: 500;
    font-size: 0.875rem;
  }

  .calculate-price-btn,
  .create-product-btn,
  .add-to-cart-btn {
    width: 100%;
    padding: 1rem 1.5rem;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 0.75rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .calculate-price-btn {
    background: #3b82f6;
  }

  .calculate-price-btn:hover {
    background: #2563eb;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  .calculate-price-btn:active {
    transform: translateY(0);
  }

  .create-product-btn {
    background: #f59e0b;
  }

  .create-product-btn:hover {
    background: #d97706;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
  }

  .add-to-cart-btn {
    background: #22c55e;
  }

  .add-to-cart-btn:hover:not(:disabled) {
    background: #16a34a;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
  }

  .add-to-cart-btn:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .btn-loader {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .calculator-title {
      font-size: 1.5rem;
    }

    .calculator-description {
      font-size: 0.875rem;
    }

    .price-value {
      font-size: 2rem;
    }

    .form-group input,
    .form-group select {
      padding: 0.75rem;
    }

    .calculate-price-btn,
    .create-product-btn,
    .add-to-cart-btn {
      padding: 0.875rem 1.25rem;
      font-size: 0.938rem;
    }
  }
</style>

{%- comment -%} JavaScript - Live Price Calculation {%- endcomment -%}
<script>
  (function () {
    const container = document.querySelector('.dynamic-price-calculator');
    const DRAWER_SECTION_ID = container?.dataset.sectionCartDrawer || 'cart-drawer';
    const ICON_SECTION_ID = container?.dataset.sectionCartIcon || 'cart-icon-bubble';
    const NOTIFICATION_SECTION_ID = document.getElementById('shopify-section-cart-notification')
      ? 'cart-notification'
      : null;
    
    // Get product information
    const PRODUCT_ID = container?.dataset.productId;
    const VARIANT_ID = container?.dataset.variantId;
    const PRODUCT_TITLE = container?.dataset.productTitle;
    const PRODUCT_IMAGE = container?.dataset.productImage;
    
    const form = document.getElementById('dynamic-price-form');
    const heightInput = document.getElementById('height-input');
    const widthInput = document.getElementById('width-input');
    const materialSelect = document.getElementById('material-select');
    const priceDisplay = document.getElementById('price-display');
    const priceValue = document.getElementById('price-value');
    const priceDetails = document.getElementById('price-details');
    const addToCartBtn = document.getElementById('add-to-cart-btn');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const infoMessage = document.getElementById('info-message');

    let currentCalculation = null; // Current calculation info
    let isAddingToCart = false; // Double-click protection

    console.log('[DynamicPriceCalculator] Initialized with product:', PRODUCT_ID, 'variant:', VARIANT_ID, 'image:', PRODUCT_IMAGE);

    // TASK 7 & 8: Pricing Rules and Live Calculation
    const MATERIAL_PRICES = {
      wood: 50,    // Wood
      metal: 100,  // Metal
      plastic: 30  // Plastic
    };

    const MATERIAL_NAMES = {
      wood: 'Wood',
      metal: 'Metal',
      plastic: 'Plastic'
    };

    // Coefficient table (based on Height Ã— Width ranges)
    const PRICE_RANGES = [
      { min: 0, max: 100000, coefficient: 1.0 },
      { min: 100000, max: 200000, coefficient: 1.2 },
      { min: 200000, max: 300000, coefficient: 1.5 },
      { min: 300000, max: Infinity, coefficient: 2.0 }
    ];

    function getCoefficient(height, width) {
      const area = height * width;
      const range = PRICE_RANGES.find(r => area >= r.min && area < r.max);
      return range ? range.coefficient : PRICE_RANGES[PRICE_RANGES.length - 1].coefficient;
    }

    function calculatePrice(height, width, material) {
      const coefficient = getCoefficient(height, width);
      const materialPrice = MATERIAL_PRICES[material];
      const area = height * width;
      const price = (area * coefficient / 10000) + materialPrice;
      return Math.round(price * 100) / 100;
    }

    // TASK 8: Live price update on form changes
    function updatePrice() {
      const height = parseInt(heightInput.value);
      const width = parseInt(widthInput.value);
      const material = materialSelect.value;

      // Validation
      if (!height || !width || !material) {
        priceDisplay.style.display = 'none';
        addToCartBtn.style.display = 'none';
        hideError();
        return;
      }

      if (height < 100 || height > 5000 || width < 100 || width > 5000) {
        showError('Height and Width must be between 100mm and 5000mm');
        priceDisplay.style.display = 'none';
        addToCartBtn.style.display = 'none';
        return;
      }

      hideError();

      // Calculate price
      const price = calculatePrice(height, width, material);
      const coefficient = getCoefficient(height, width);
      const area = height * width;
      const materialName = MATERIAL_NAMES[material];

      // Store calculation info
      currentCalculation = {
        height,
        width,
        material,
        materialName,
        price,
        coefficient,
        area
      };

      // Update price display
      priceValue.textContent = `${price.toFixed(2)} $`;
      priceDetails.innerHTML = `
        Area: ${area.toLocaleString()} mmÂ² â€¢ 
        Coefficient: ${coefficient} â€¢ 
        Material: ${materialName}
      `;
      priceDisplay.style.display = 'block';
      
      // Enable add to cart button
      addToCartBtn.style.display = 'block';
      addToCartBtn.disabled = false;
    }

    // Input event listeners - TASK 8: Live updates
    heightInput.addEventListener('input', updatePrice);
    widthInput.addEventListener('input', updatePrice);
    materialSelect.addEventListener('change', updatePrice);

    // Also check on blur events
    heightInput.addEventListener('blur', updatePrice);
    widthInput.addEventListener('blur', updatePrice);

    // TASK 9 & 10: Add to Cart - Create temp product with backend!
    addToCartBtn.addEventListener('click', async () => {
      if (isAddingToCart) return; // Double-click protection
      
      if (!currentCalculation) {
        showError('Please enter valid values first');
        return;
      }

      isAddingToCart = true;
      addToCartBtn.disabled = true;
      addToCartBtn.querySelector('.btn-text').style.display = 'none';
      addToCartBtn.querySelector('.btn-loader').style.display = 'flex';
      hideError();
      hideSuccess();
      hideInfo();

      try {
        console.log('[TempProduct] Creating product via backend...');
        console.log('[TempProduct] Calculation:', currentCalculation);

        // Send request to backend - Create temp product
        const formData = new FormData();
        formData.append('height', currentCalculation.height);
        formData.append('width', currentCalculation.width);
        formData.append('material', currentCalculation.material);
        
        // Add product image
        if (PRODUCT_IMAGE) {
          formData.append('imageUrl', PRODUCT_IMAGE);
        }

        const createResponse = await fetch('/apps/proxy/create-temp-product', {
          method: 'POST',
          body: formData,
        });

        if (!createResponse.ok) {
          throw new Error('Product creation failed - Backend did not respond');
        }

        const createData = await createResponse.json();

        if (!createData.success || !createData.product) {
          throw new Error(createData.error || 'Product creation failed');
        }

        const product = createData.product;
        console.log('[TempProduct] âœ… Created:', product);

        // Add to cart (with retry)
        await attemptAddToCart(product, 0);

      } catch (error) {
        console.error('[ERROR] Add to cart:', error);
        const errorMsg = error instanceof Error ? error.message : 'Operation failed';
        
        if (errorMsg.includes('Backend') || errorMsg.includes('fetch')) {
          showError('âš ï¸ Backend connection failed. Please make sure the app is running.\n\nDevelopment: npm run dev\nProduction: App needs to be deployed.');
        } else {
          showError(errorMsg);
        }
        
        addToCartBtn.querySelector('.btn-loader').style.display = 'none';
        addToCartBtn.querySelector('.btn-text').style.display = 'inline';
        addToCartBtn.disabled = false;
        isAddingToCart = false;
      }
    });

    // TASK 10: Add to cart attempt (with retry mechanism)
    const MAX_RETRIES = 7; // Backend is creating product, need to wait
    const RETRY_INTERVAL = 700;

    async function attemptAddToCart(product, tryIndex) {
      console.log(`[CartAttempt] Attempt ${tryIndex + 1}/${MAX_RETRIES}`);
      
      try {
        // Use temp product variant ID from backend
        const variantId = product.variantId;
        
        console.log(`[Cart] Variant ID: ${variantId}, Price: ${product.price} $`);
        
        // Add to cart
        const resp = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: variantId,
            quantity: 1,
            properties: {
              'Height (mm)': currentCalculation.height.toString(),
              'Width (mm)': currentCalculation.width.toString(),
              'Material': currentCalculation.materialName,
              'Area (mmÂ²)': currentCalculation.area.toLocaleString(),
              'Coefficient': currentCalculation.coefficient.toString(),
              'Custom Price': `${product.price.toFixed(2)} $`
            },
            sections: [ICON_SECTION_ID, DRAWER_SECTION_ID, NOTIFICATION_SECTION_ID].filter(Boolean),
            sections_url: window.location.pathname,
          }),
        });

        if (resp.ok) {
          const data = await resp.json();
          console.log('[SUCCESS] âœ… Added to cart:', data);

          // Update sections
          if (data?.sections && typeof data.sections === 'object') {
            replaceSectionsHtml(data.sections);
          }

          // Update cart UI
          await updateCartUI();

          // Open drawer
          openCartDrawer();

          // Success message
          const successMsg = `âœ“ Product added to cart!\n\nðŸ’° Custom Price: ${product.price.toFixed(2)} $\n\nâœ… Correct price will be shown in cart!`;
          showSuccess(successMsg);
          
          // Update button
          addToCartBtn.querySelector('.btn-loader').style.display = 'none';
          addToCartBtn.querySelector('.btn-text').style.display = 'inline';
          addToCartBtn.querySelector('.btn-text').textContent = 'âœ“ Added to Cart';
          isAddingToCart = false;
          
          // Reset UI
          setTimeout(() => {
            resetForm();
          }, 2500);

        } else {
          const err = await resp.json().catch(() => ({}));
          
          // Variant not ready yet, wait
          if (err?.description === 'Cannot find variant' && tryIndex < MAX_RETRIES - 1) {
            showInfo('â³ Product being prepared... Please wait.');
            setTimeout(() => attemptAddToCart(product, tryIndex + 1), RETRY_INTERVAL);
          } else {
            throw new Error(err?.message || err?.description || 'Failed to add to cart');
          }
        }

      } catch (error) {
        if (tryIndex < MAX_RETRIES - 1) {
          showInfo('ðŸ”„ Retrying...');
          setTimeout(() => attemptAddToCart(product, tryIndex + 1), RETRY_INTERVAL);
        } else {
          throw error;
        }
      }
    }

    // Helper Functions
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
    }

    function hideError() {
      errorMessage.style.display = 'none';
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
    }

    function hideSuccess() {
      successMessage.style.display = 'none';
    }

    function showInfo(message) {
      infoMessage.textContent = message;
      infoMessage.style.display = 'block';
    }

    function hideInfo() {
      infoMessage.style.display = 'none';
    }

    function resetForm() {
      heightInput.value = '';
      widthInput.value = '';
      materialSelect.value = '';
      priceDisplay.style.display = 'none';
      addToCartBtn.style.display = 'none';
      addToCartBtn.querySelector('.btn-text').textContent = 'Add to Cart';
      currentCalculation = null;
      isAddingToCart = false;
      hideError();
      hideSuccess();
      hideInfo();
    }

    // Section HTML gÃ¼ncelleme
    function replaceSectionsHtml(sectionsMap) {
      if (!sectionsMap) return;
      const sectionIds = [ICON_SECTION_ID, DRAWER_SECTION_ID, NOTIFICATION_SECTION_ID].filter(Boolean);
      sectionIds.forEach((sid) => {
        const html = sectionsMap[sid];
        if (!html) return;
        const containerId = `shopify-section-${sid}`;
        const container = document.getElementById(containerId);
        if (!container) return;
        const wrapper = document.createElement('div');
        wrapper.innerHTML = html;
        const nextEl = wrapper.firstElementChild;
        if (nextEl && nextEl.id === containerId) {
          container.replaceWith(nextEl);
        } else {
          container.innerHTML = html;
        }
      });
    }

    // Cart UI gÃ¼ncelleme
    async function updateCartUI() {
      try {
        const cartResp = await fetch('/cart.js');
        if (cartResp.ok) {
          const cartData = await cartResp.json();
          const itemCount = cartData.item_count;
          
          // Cart sayacÄ±nÄ± gÃ¼ncelle
          const selectors = [
            '[data-cart-count]',
            '#cart-count',
            '.cart-count-bubble .count',
            '.cart-count-bubble[data-cart-count-bubble]',
            '.header__icon--cart .cart-count-bubble',
          ];
          const unique = new Set();
          selectors.forEach((sel) => {
            document.querySelectorAll(sel).forEach((el) => unique.add(el));
          });
          unique.forEach((el) => {
            const inner = el.querySelector?.('.count') || el;
            inner.textContent = itemCount.toString();
            el.classList?.toggle('hidden', itemCount === 0);
          });

          // Custom event yayÄ±nla
          document.documentElement.dispatchEvent(
            new CustomEvent('cart:refresh', {
              bubbles: true,
              detail: { cart: cartData },
            })
          );
        }
      } catch (e) {
        console.warn('[Cart] Update failed:', e);
      }
    }

    // Cart drawer aÃ§ma
    function openCartDrawer() {
      setTimeout(() => {
        // Dawn theme pattern
        const drawerEl = document.querySelector('cart-drawer');
        if (drawerEl) {
          if (typeof drawerEl.open === 'function') {
            drawerEl.open();
          } else if (typeof drawerEl.renderContents === 'function') {
            drawerEl.renderContents().then(() => drawerEl.open?.());
          }
        }

        // DiÄŸer temalar iÃ§in genel toggle
        const drawerToggle =
          document.querySelector('[data-cart-drawer-toggle]') ||
          document.querySelector('.cart-drawer__toggle') ||
          document.querySelector('#cart-icon-bubble');
        if (drawerToggle && !drawerEl) {
          drawerToggle.click();
        }

        // Fallback: custom event
        document.dispatchEvent(new CustomEvent('cart:open', { bubbles: true }));
      }, 100);
    }

  })();
</script>
{% schema %}
{
  "name": "Dynamic Price Calculator",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Enter Your Custom Measurements"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Calculate your custom price by entering height, width and material information."
    },
    {
      "type": "text",
      "id": "cart_drawer_section_id",
      "label": "Cart Drawer Section ID",
      "default": "cart-drawer",
      "info": "The cart drawer section ID in your theme (e.g: cart-drawer)."
    },
    {
      "type": "text",
      "id": "cart_icon_section_id",
      "label": "Cart Icon/Bubble Section ID",
      "default": "cart-icon-bubble",
      "info": "The cart icon/counter section ID in your theme (e.g: cart-icon-bubble)."
    }
  ]
}
{% endschema %}
