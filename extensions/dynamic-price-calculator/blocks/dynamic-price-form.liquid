{% comment %}
  Dinamik Fiyat Hesaplayıcı - Tema Bloğu
  
  Bu blok ürün sayfasına eklenerek kullanıcıdan:
  - Boy (mm)
  - En (mm)  
  - Materyal (Ahşap/Metal/Plastik)
  bilgilerini alır ve dinamik fiyat hesaplar.
{% endcomment %}

<div class="dynamic-price-calculator" data-product-id="{{ product.id }}">
  <div class="calculator-form">
    <h3 class="calculator-title">{{ block.settings.title }}</h3>
    <p class="calculator-description">{{ block.settings.description }}</p>
    
    <form id="dynamic-price-form" class="price-form">
      {%- comment -%} Boy girişi {%- endcomment -%}
      <div class="form-group">
        <label for="height-input">
          Boy (mm)
          <span class="required">*</span>
        </label>
        <input 
          type="number" 
          id="height-input" 
          name="height" 
          min="100" 
          max="5000" 
          step="1"
          placeholder="Örn: 400"
          required
        >
        <small class="help-text">100mm - 5000mm arası</small>
      </div>
      
      {%- comment -%} En girişi {%- endcomment -%}
      <div class="form-group">
        <label for="width-input">
          En (mm)
          <span class="required">*</span>
        </label>
        <input 
          type="number" 
          id="width-input" 
          name="width" 
          min="100" 
          max="5000" 
          step="1"
          placeholder="Örn: 500"
          required
        >
        <small class="help-text">100mm - 5000mm arası</small>
      </div>
      
      {%- comment -%} Materyal seçimi {%- endcomment -%}
      <div class="form-group">
        <label for="material-select">
          Materyal
          <span class="required">*</span>
        </label>
        <select id="material-select" name="material" required>
          <option value="">Seçiniz...</option>
          <option value="wood">Ahşap (+50 TL)</option>
          <option value="metal">Metal (+100 TL)</option>
          <option value="plastic">Plastik (+30 TL)</option>
        </select>
      </div>
      
      {%- comment -%} Dinamik fiyat gösterimi {%- endcomment -%}
      <div class="price-display" id="price-display" style="display: none;">
        <div class="price-label">Tahmini Fiyat:</div>
        <div class="price-value" id="price-value">0.00 TL</div>
        <div class="price-details" id="price-details"></div>
      </div>
      
      {%- comment -%} Hata mesajları {%- endcomment -%}
      <div class="error-message" id="error-message" style="display: none;"></div>
      
      {%- comment -%} Fiyat hesapla butonu {%- endcomment -%}
      <button 
        type="button" 
        class="calculate-price-btn" 
        id="calculate-price-btn"
      >
        <span class="btn-text">Fiyat Hesapla</span>
      </button>
      
      {%- comment -%} Ürün oluştur butonu {%- endcomment -%}
      <button 
        type="button" 
        class="create-product-btn" 
        id="create-product-btn"
        style="display: none;"
      >
        <span class="btn-text">Ürün Oluştur</span>
        <span class="btn-loader" style="display: none;">
          <span class="spinner"></span>
          Oluşturuluyor...
        </span>
      </button>
      
      {%- comment -%} Sepete ekle butonu (ürün oluştuktan sonra gösterilecek) {%- endcomment -%}
      <button 
        type="button" 
        class="add-to-cart-btn" 
        id="add-to-cart-btn"
        style="display: none;"
      >
        <span class="btn-text">Sepete Ekle</span>
        <span class="btn-loader" style="display: none;">
          <span class="spinner"></span>
          Ekleniyor...
        </span>
      </button>
      
      {%- comment -%} Başarı mesajı {%- endcomment -%}
      <div class="success-message" id="success-message" style="display: none;">
        ✓ Ürün başarıyla sepete eklendi!
      </div>
      
      {%- comment -%} Info mesajı {%- endcomment -%}
      <div class="info-message" id="info-message" style="display: none;"></div>
    </form>
  </div>
</div>

{%- comment -%} Stil {%- endcomment -%}
<style>
  .dynamic-price-calculator {
    margin: 2rem 0;
    padding: 1.5rem;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: #f9f9f9;
  }
  
  .calculator-title {
    margin: 0 0 0.5rem;
    font-size: 1.5rem;
    font-weight: 600;
    color: #333;
  }
  
  .calculator-description {
    margin: 0 0 1.5rem;
    color: #666;
    font-size: 0.95rem;
  }
  
  .form-group {
    margin-bottom: 1.25rem;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #333;
  }
  
  .required {
    color: #e74c3c;
  }
  
  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
    transition: border-color 0.2s;
  }
  
  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: #4CAF50;
  }
  
  .help-text {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.85rem;
    color: #888;
  }
  
  .price-display {
    margin: 1.5rem 0;
    padding: 1rem;
    background: #fff;
    border: 2px solid #4CAF50;
    border-radius: 8px;
    text-align: center;
  }
  
  .price-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.5rem;
  }
  
  .price-value {
    font-size: 2rem;
    font-weight: 700;
    color: #4CAF50;
  }
  
  .price-details {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: #888;
  }
  
  .error-message {
    padding: 0.75rem;
    background: #ffebee;
    border: 1px solid #ef5350;
    border-radius: 4px;
    color: #c62828;
    margin-bottom: 1rem;
  }
  
  .success-message {
    padding: 0.75rem;
    background: #e8f5e9;
    border: 1px solid #66bb6a;
    border-radius: 4px;
    color: #2e7d32;
    margin-top: 1rem;
    text-align: center;
  }
  
  .info-message {
    padding: 0.75rem;
    background: #e3f2fd;
    border: 1px solid #42a5f5;
    border-radius: 4px;
    color: #1565c0;
    margin-top: 1rem;
    text-align: center;
    font-size: 0.9rem;
  }
  
  .calculate-price-btn,
  .create-product-btn,
  .add-to-cart-btn {
    width: 100%;
    padding: 1rem;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    margin-top: 0.5rem;
  }
  
  .calculate-price-btn {
    background: #2196F3;
  }
  
  .calculate-price-btn:hover {
    background: #1976D2;
  }
  
  .create-product-btn {
    background: #FF9800;
  }
  
  .create-product-btn:hover {
    background: #F57C00;
  }
  
  .add-to-cart-btn {
    background: #4CAF50;
  }
  
  .add-to-cart-btn:hover:not(:disabled) {
    background: #45a049;
  }
  
  .add-to-cart-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  
  .btn-loader {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }
  
  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  @media (max-width: 768px) {
    .dynamic-price-calculator {
      padding: 1rem;
    }
    
    .calculator-title {
      font-size: 1.25rem;
    }
    
    .price-value {
      font-size: 1.75rem;
    }
  }
</style>

{%- comment -%} JavaScript {%- endcomment -%}
<script>
(function() {
  const form = document.getElementById('dynamic-price-form');
  const heightInput = document.getElementById('height-input');
  const widthInput = document.getElementById('width-input');
  const materialSelect = document.getElementById('material-select');
  const priceDisplay = document.getElementById('price-display');
  const priceValue = document.getElementById('price-value');
  const priceDetails = document.getElementById('price-details');
  
  const calculateBtn = document.getElementById('calculate-price-btn');
  const createProductBtn = document.getElementById('create-product-btn');
  const addToCartBtn = document.getElementById('add-to-cart-btn');
  
  const errorMessage = document.getElementById('error-message');
  const successMessage = document.getElementById('success-message');
  const infoMessage = document.getElementById('info-message');
  
  let createdProduct = null; // Oluşturulan ürün bilgisi
  
  // 1. ADIM: Fiyat Hesapla
  calculateBtn.addEventListener('click', async () => {
    const height = parseInt(heightInput.value);
    const width = parseInt(widthInput.value);
    const material = materialSelect.value;
    
    // Validasyon
    if (!height || !width || !material) {
      showError('Lütfen tüm alanları doldurun');
      return;
    }
    
    if (height < 100 || height > 5000 || width < 100 || width > 5000) {
      showError('Boy ve En 100mm ile 5000mm arasında olmalıdır');
      return;
    }
    
    calculateBtn.disabled = true;
    calculateBtn.textContent = 'Hesaplanıyor...';
    hideError();
    hideSuccess();
    hideInfo();
    
    try {
      const formData = new FormData();
      formData.append('height', height);
      formData.append('width', width);
      formData.append('material', material);
      
      const response = await fetch('/apps/proxy/calculate-price', {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if (data.success) {
        priceValue.textContent = data.calculation.formatted;
        priceDetails.innerHTML = `
          Alan: ${data.calculation.area.toLocaleString()} mm² • 
          Katsayı: ${data.calculation.coefficient} • 
          Materyal: ${data.calculation.material}
        `;
        priceDisplay.style.display = 'block';
        createProductBtn.style.display = 'block';
        hideError();
      } else {
        showError(data.error);
      }
    } catch (error) {
      console.error('[ERROR] Fiyat hesaplama:', error);
      showError('Fiyat hesaplanamadı');
    } finally {
      calculateBtn.disabled = false;
      calculateBtn.textContent = 'Fiyat Hesapla';
    }
  });
  
  // 2. ADIM: Ürün Oluştur
  createProductBtn.addEventListener('click', async () => {
    const height = parseInt(heightInput.value);
    const width = parseInt(widthInput.value);
    const material = materialSelect.value;
    
    createProductBtn.disabled = true;
    createProductBtn.querySelector('.btn-text').style.display = 'none';
    createProductBtn.querySelector('.btn-loader').style.display = 'flex';
    hideError();
    hideSuccess();
    hideInfo();
    
    try {
      const formData = new FormData();
      formData.append('height', height);
      formData.append('width', width);
      formData.append('material', material);
      
      const response = await fetch('/apps/proxy/create-temp-product', {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      console.log('[DEBUG] Backend response:', data);
      
      if (data.success && data.product) {
        createdProduct = data.product;
        console.log('[SUCCESS] Product created:', createdProduct);
        
        // Ürün oluşturuldu mesajı göster
        createProductBtn.style.display = 'none';
        addToCartBtn.style.display = 'block';
        addToCartBtn.disabled = true;
        
        // 5 saniye geri sayım (Ürün publish edildiği için kısa sürede hazır)
        let countdown = 5;
        showInfo(`✓ Ürün oluşturuldu ve yayınlandı! Sepete eklemek için ${countdown} saniye bekleyin...`);
        
        const countdownInterval = setInterval(() => {
          countdown--;
          if (countdown > 0) {
            showInfo(`✓ Ürün oluşturuldu ve yayınlandı! Sepete eklemek için ${countdown} saniye bekleyin...`);
          } else {
            clearInterval(countdownInterval);
            addToCartBtn.disabled = false;
            showInfo(`✓ Ürün hazır! Şimdi "Sepete Ekle" butonuna tıklayabilirsiniz.`);
          }
        }, 1000);
      } else {
        showError(data.error || 'Ürün oluşturulamadı');
      }
    } catch (error) {
      console.error('[ERROR] Ürün oluşturma:', error);
      showError('Ürün oluşturulamadı');
    } finally {
      createProductBtn.disabled = false;
      createProductBtn.querySelector('.btn-text').style.display = 'inline';
      createProductBtn.querySelector('.btn-loader').style.display = 'none';
    }
  });
  
  // 3. ADIM: Sepete Ekle
  addToCartBtn.addEventListener('click', async () => {
    if (!createdProduct) {
      showError('Önce ürün oluşturmalısınız');
      return;
    }
    
    addToCartBtn.disabled = true;
    addToCartBtn.querySelector('.btn-text').style.display = 'none';
    addToCartBtn.querySelector('.btn-loader').style.display = 'flex';
    hideError();
    hideSuccess();
    hideInfo();
    
    try {
      console.log('[INFO] Adding to cart, variant ID:', createdProduct.variantId);
      
      const cartResponse = await fetch('/cart/add.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          id: createdProduct.variantId,
          quantity: 1,
          properties: {
            'Boyut': `${createdProduct.height}×${createdProduct.width}mm`,
            'Materyal': createdProduct.material,
            'Özel Fiyat': `${createdProduct.price} TL`
          }
        })
      });
      
      if (cartResponse.ok) {
        const cartData = await cartResponse.json();
        console.log('[SUCCESS] Added to cart:', cartData);
        showSuccess('✓ Ürün sepete eklendi!');
        
        // Formu sıfırla
        setTimeout(() => {
          resetForm();
        }, 2000);
      } else {
        const errorData = await cartResponse.json().catch(() => ({}));
        console.warn('[WARNING] Cart add failed:', errorData);
        
        if (errorData.description === 'Cannot find variant') {
          showError('⏳ Ürün hala hazırlanıyor. Lütfen 20-30 saniye daha bekleyip tekrar "Sepete Ekle" butonuna tıklayın. (Shopify\'ın indexing süreci uzun sürebilir)');
        } else {
          showError('Sepete eklenemedi. Lütfen tekrar deneyin.');
        }
      }
    } catch (error) {
      console.error('[ERROR] Cart add:', error);
      showError('Sepete eklenemedi. Lütfen tekrar deneyin.');
    } finally {
      addToCartBtn.disabled = false;
      addToCartBtn.querySelector('.btn-text').style.display = 'inline';
      addToCartBtn.querySelector('.btn-loader').style.display = 'none';
    }
  });
  
  // Yardımcı fonksiyonlar
  function showError(message) {
    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
  }
  
  function hideError() {
    errorMessage.style.display = 'none';
  }
  
  function showSuccess(message) {
    if (message) {
      successMessage.textContent = message;
    }
    successMessage.style.display = 'block';
  }
  
  function hideSuccess() {
    successMessage.style.display = 'none';
  }
  
  function showInfo(message) {
    infoMessage.textContent = message;
    infoMessage.style.display = 'block';
  }
  
  function hideInfo() {
    infoMessage.style.display = 'none';
  }
  
  function resetForm() {
    heightInput.value = '';
    widthInput.value = '';
    materialSelect.value = '';
    priceDisplay.style.display = 'none';
    createProductBtn.style.display = 'none';
    addToCartBtn.style.display = 'none';
    createdProduct = null;
    hideError();
    hideSuccess();
    hideInfo();
  }
})();
</script>
{% schema %}
{
  "name": "Dinamik Fiyat Hesaplayıcı",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Başlık",
      "default": "Özel Ölçülerinizi Girin"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Açıklama",
      "default": "Ürününüzün boy, en ve materyal bilgilerini girerek özel fiyatınızı hesaplayın."
    }
  ]
}
{% endschema %}
